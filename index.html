<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>מה שראיתי כשקמתי</title>

  <!-- Favicon -->
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔆</text></svg>" />

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <!-- language switch -->
  <div class="lang-container">
    <button id="heBtn" class="lang-switch active">עברית</button>
    <button id="enBtn" class="lang-switch">English</button>
  </div>

  <!-- memoir content -->
  <main id="main" class="container" dir="rtl">
    <div id="content">טוען…</div>
  </main>

  <!-- bottom nav bar -->
  <nav id="bottomNav" class="bottom-nav hide">
    <button id="prevBtn" aria-label="Previous section">⬆️</button>
    <button id="tocBtn"  aria-label="Table of contents">🗂️</button>
    <button id="nextBtn" aria-label="Next section">⬇️</button>
  </nav>

  <!-- TOC drawer -->
  <aside id="tocOverlay" class="toc-overlay">
    <div class="toc-sheet">
      <h3>תוכן עניינים</h3>
      <ul id="tocList"></ul>
    </div>
  </aside>

  <!-- footer -->
  <footer id="contact">
    <div class="contact-info">
      <a href="https://www.instagram.com/tully_hoffmann" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Instagram_logo_2022.svg/256px-Instagram_logo_2022.svg.png"
             alt="" class="icon" />Tully Instagram
      </a>
      <a href="https://www.instagram.com/rawpresence" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Instagram_logo_2022.svg/256px-Instagram_logo_2022.svg.png"
             alt="" class="icon" />Raw Presence Lab
      </a>
      <a href="mailto:tullyhoffmann@gmail.com">✉️ Email</a>
    </div>
    <p class="copyright">© 2025 Tully Hoffmann — All rights reserved</p>
  </footer>

  <script>
    /* -------- markdown loader -------- */
    const contentEl = document.getElementById('content');
    const mainEl    = document.getElementById('main');
    const heBtn     = document.getElementById('heBtn');
    const enBtn     = document.getElementById('enBtn');

    let headings = [];
    let currentIndex = 0;

    function loadLanguage(lang) {
      const file = (lang === 'en') ? 'memoir.md' : 'memoir-he.md';
      fetch(file)
        .then(r => r.text())
        .then(md => {
          marked.setOptions({ breaks: true });
          contentEl.innerHTML = marked.parse(md);
          buildTOC();   // rebuild after language switch
          observeSections();
        });
      document.documentElement.lang = lang;
      mainEl.setAttribute('dir', lang === 'he' ? 'rtl' : 'ltr');
      heBtn.classList.toggle('active', lang === 'he');
      enBtn.classList.toggle('active', lang === 'en');
    }
    heBtn.addEventListener('click', () => loadLanguage('he'));
    enBtn.addEventListener('click', () => loadLanguage('en'));
    loadLanguage('he');   // default

    /* -------- build TOC & anchor IDs -------- */
    const tocOverlay = document.getElementById('tocOverlay');
    const tocList    = document.getElementById('tocList');
    function buildTOC() {
      tocList.innerHTML = '';
      headings = Array.from(contentEl.querySelectorAll('h2'));
      headings.forEach((h, i) => {
        const id = `section-${i}`;
        h.id = id;
        const li = document.createElement('li');
        li.innerHTML = `<a href="#${id}">${h.textContent}</a>`;
        tocList.appendChild(li);
      });
    }

    /* -------- Intersection Observer for current section -------- */
    function observeSections() {
      const observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              currentIndex = headings.indexOf(entry.target);
              updateNavState();
            }
          });
        }, { rootMargin: '-40% 0px -40% 0px' }
      );
      headings.forEach(h => observer.observe(h));
    }

    /* -------- bottom nav actions -------- */
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    prevBtn.onclick = () => { if (currentIndex > 0) headings[currentIndex-1].scrollIntoView({behavior:'smooth'}); };
    nextBtn.onclick = () => { if (currentIndex < headings.length-1) headings[currentIndex+1].scrollIntoView({behavior:'smooth'}); };

    /* toc drawer toggle */
    const tocBtn = document.getElementById('tocBtn');
    tocBtn.onclick = () => tocOverlay.classList.add('open');
    tocOverlay.onclick = e => { if (e.target === tocOverlay) tocOverlay.classList.remove('open'); };
    tocList.addEventListener('click', () => tocOverlay.classList.remove('open'));

    function updateNavState(){
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === headings.length-1;
    }

    /* -------- scroll progress bar -------- */
    const root = document.documentElement;
    window.addEventListener('scroll', () => {
      const h = document.documentElement.scrollHeight - innerHeight;
      root.style.setProperty('--scroll', `${(scrollY / h) * 100}%`);
    });

    /* -------- hide / show bottom nav on scroll -------- */
    const bottomNav = document.getElementById('bottomNav');
    let lastPos = 0, navTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(navTimeout);
      const cur = scrollY;
      if (cur > lastPos + 10) bottomNav.classList.add('hide'); // scrolling down
      lastPos = cur;
      navTimeout = setTimeout(() => bottomNav.classList.remove('hide'), 150); // stopped / up
    }, { passive: true });
  </script>
</body>
</html>